<!DOCTYPE html>
<html>
<head>
  <title>Juju Dashboard</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', sans-serif;
      margin: 0;
      padding: 20px;
      color: #333;
      background-color: #f5f5f5;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    h1 {
      font-size: 24px;
      margin: 0;
      padding: 20px;
      background-color: #0078d7;
      color: white;
    }
    
    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      background-color: #f9f9f9;
    }
    
    .tab {
      padding: 12px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }
    
    .tab.active {
      border-bottom-color: #0078d7;
      font-weight: 500;
    }
    
    .tab-content {
      display: none;
      padding: 20px;
    }
    
    .tab-content.active {
      display: block;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      text-align: left;
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    
    th {
      background-color: #f5f5f5;
      font-weight: 500;
    }
    
    tr:hover {
      background-color: #f9f9f9;
    }
    
    .editable:hover {
      background-color: #e9f5ff;
      cursor: pointer;
    }
    
    input[type="text"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    
    .chart-container {
      height: 300px;
      margin-bottom: 30px;
    }
    
    .no-data {
      text-align: center;
      padding: 50px 0;
      color: #888;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Juju Dashboard</h1>
    
    <div class="tabs">
      <div class="tab active" data-tab="sessions">Sessions</div>
      <div class="tab" data-tab="charts">Charts</div>
    </div>
    
    <div id="sessions" class="tab-content active">
      <div id="sessions-table-container">
        <table id="sessions-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Project</th>
              <th>Duration</th>
              <th>Start</th>
              <th>End</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody id="sessions-body">
            <!-- Sessions will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>
    
    <div id="charts" class="tab-content">
      <div class="chart-container">
        <h3>Weekly Hours by Project</h3>
        <canvas id="weekly-chart"></canvas>
      </div>
      <div class="chart-container">
        <h3>Project Distribution</h3>
        <canvas id="pie-chart"></canvas>
      </div>
    </div>
  </div>

  <script>
    // Load Chart.js from CDN
    const chartScript = document.createElement('script');
    chartScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js';
    document.head.appendChild(chartScript);
    
    // Tab functionality
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        // Deactivate all tabs
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // Activate clicked tab
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
      });
    });
    
    // Load sessions data
    async function loadSessions() {
      try {
        const sessions = await window.api.loadSessions();
        
        if (sessions.length === 0) {
          document.getElementById('sessions-body').innerHTML = `
            <tr>
              <td colspan="6" class="no-data">No sessions recorded yet. Start a session to begin tracking.</td>
            </tr>
          `;
          return;
        }
        
        // Sort sessions by date, newest first
        sessions.sort((a, b) => new Date(b.date + ' ' + b.start_time) - new Date(a.date + ' ' + a.start_time));
        
        const tbody = document.getElementById('sessions-body');
        tbody.innerHTML = '';
        
        sessions.forEach((session, index) => {
          const row = document.createElement('tr');
          
          // Format date for display
          const dateObj = new Date(session.date);
          const formattedDate = dateObj.toLocaleDateString();
          
          row.innerHTML = `
            <td>${formattedDate}</td>
            <td class="editable" data-field="project" data-id="${index}">${session.project}</td>
            <td>${session.duration_minutes} min</td>
            <td>${session.start_time}</td>
            <td>${session.end_time}</td>
            <td class="editable" data-field="notes" data-id="${index}">${session.notes}</td>
          `;
          
          tbody.appendChild(row);
        });
        
        // Make cells editable on click
        document.querySelectorAll('.editable').forEach(cell => {
          cell.addEventListener('click', function() {
            const value = this.textContent;
            const field = this.dataset.field;
            const id = this.dataset.id;
            
            // Replace with input
            this.innerHTML = `<input type="text" value="${value}">`;
            const input = this.querySelector('input');
            input.focus();
            input.select();
            
            // Handle blur and Enter key
            input.addEventListener('blur', async function() {
              const newValue = this.value;
              cell.textContent = newValue;
              
              // Save to CSV
              await window.api.updateSession(id, field, newValue);
            });
            
            input.addEventListener('keydown', function(e) {
              if (e.key === 'Enter') {
                this.blur();
              }
            });
          });
        });
        
        // Initialize charts once data is loaded
        chartScript.onload = () => initCharts(sessions);
        
      } catch (error) {
        console.error('Error loading sessions:', error);
        document.getElementById('sessions-body').innerHTML = `
          <tr>
            <td colspan="6" class="no-data">Error loading sessions: ${error.message}</td>
          </tr>
        `;
      }
    }
    
    // Initialize charts
    function initCharts(sessions) {
      // Prepare data for weekly chart
      const weekData = prepareWeeklyData(sessions);
      
      // Prepare data for pie chart
      const pieData = preparePieData(sessions);
      
      // Create weekly chart
      const weeklyCtx = document.getElementById('weekly-chart').getContext('2d');
      new Chart(weeklyCtx, {
        type: 'bar',
        data: {
          labels: weekData.labels,
          datasets: weekData.datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Hours'
              }
            }
          }
        }
      });
      
      // Create pie chart
      const pieCtx = document.getElementById('pie-chart').getContext('2d');
      new Chart(pieCtx, {
        type: 'pie',
        data: {
          labels: pieData.labels,
          datasets: [{
            data: pieData.data,
            backgroundColor: generateColors(pieData.labels.length)
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }
    
    // Prepare data for weekly chart
    function prepareWeeklyData(sessions) {
      // Get the current date and start of week
      const now = new Date();
      const startOfWeek = new Date(now);
      startOfWeek.setDate(now.getDate() - now.getDay());
      startOfWeek.setHours(0, 0, 0, 0);
      
      // Create date labels for the past 7 days
      const labels = [];
      for (let i = 6; i >= 0; i--) {
        const d = new Date(now);
        d.setDate(now.getDate() - i);
        labels.push(d.toLocaleDateString('en-US', { weekday: 'short' }));
      }
      
      // Group sessions by project and day
      const projectData = {};
      
      sessions.forEach(session => {
        const sessionDate = new Date(session.date);
        
        // Only include sessions from the past week
        if (sessionDate >= startOfWeek) {
          const dayIndex = 6 - Math.floor((now - sessionDate) / (1000 * 60 * 60 * 24));
          
          if (!projectData[session.project]) {
            projectData[session.project] = Array(7).fill(0);
          }
          
          // Convert minutes to hours
          projectData[session.project][dayIndex] += session.duration_minutes / 60;
        }
      });
      
      // Create datasets for chart
      const datasets = Object.keys(projectData).map((project, index) => {
        return {
          label: project,
          data: projectData[project],
          backgroundColor: getColor(index)
        };
      });
      
      return { labels, datasets };
    }
    
    // Prepare data for pie chart
    function preparePieData(sessions) {
      // Group by project
      const projectTotals = {};
      
      sessions.forEach(session => {
        if (!projectTotals[session.project]) {
          projectTotals[session.project] = 0;
        }
        
        projectTotals[session.project] += session.duration_minutes;
      });
      
      const labels = Object.keys(projectTotals);
      const data = labels.map(label => projectTotals[label] / 60); // Convert to hours
      
      return { labels, data };
    }
    
    // Generate colors for charts
    function generateColors(count) {
      const colors = [
        '#4E79A7', '#F28E2B', '#E15759', '#76B7B2', '#59A14F',
        '#EDC948', '#B07AA1', '#FF9DA7', '#9C755F', '#BAB0AC'
      ];
      
      return Array(count).fill().map((_, i) => colors[i % colors.length]);
    }
    
    function getColor(index) {
      const colors = [
        '#4E79A7', '#F28E2B', '#E15759', '#76B7B2', '#59A14F',
        '#EDC948', '#B07AA1', '#FF9DA7', '#9C755F', '#BAB0AC'
      ];
      
      return colors[index % colors.length];
    }
    
    // Load sessions when the page loads
    document.addEventListener('DOMContentLoaded', loadSessions);
  </script>
</body>
</html>