<!DOCTYPE html>
<html>
<head>
  <title>Juju Dashboard</title>
  <link rel="stylesheet" href="dashboard.css">
  <meta charset="UTF-8">
</head>
<body>
  <div class="container">
    <h1>Juju Work Tracker</h1>
    
    <div class="summary">
      <h2>Today's Summary</h2>
      <div id="today-stats"></div>
    </div>
    
    <div class="sessions">
      <h2>Recent Sessions</h2>
      <table id="sessions-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Project</th>
            <th>Start</th>
            <th>End</th>
            <th>Duration</th>
            <th>Notes</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="sessions-body">
          <!-- Sessions will be inserted here -->
        </tbody>
      </table>
    </div>
    
    <!-- Edit Modal -->
    <div id="edit-modal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Edit Session</h2>
        <form id="edit-form">
          <input type="hidden" id="edit-row-index">
          
          <div class="form-group">
            <label for="edit-date">Date:</label>
            <input type="date" id="edit-date" required>
          </div>
          
          <div class="form-group">
            <label for="edit-project">Project:</label>
            <input type="text" id="edit-project" required>
          </div>
          
          <div class="form-group">
            <label for="edit-start">Start Time:</label>
            <input type="time" id="edit-start" required>
          </div>
          
          <div class="form-group">
            <label for="edit-end">End Time:</label>
            <input type="time" id="edit-end" required>
          </div>
          
          <div class="form-group">
            <label for="edit-notes">Notes:</label>
            <textarea id="edit-notes" rows="3"></textarea>
          </div>
          
          <div class="form-actions">
            <button type="submit">Save Changes</button>
            <button type="button" class="cancel">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <script>
    // Global variables
    let csvData = '';
    let sessions = [];
    const modal = document.getElementById('edit-modal');
    const closeBtn = document.querySelector('.close');
    const cancelBtn = document.querySelector('.cancel');
    const editForm = document.getElementById('edit-form');
    
    // Close modal when clicking X or Cancel
    closeBtn.onclick = () => modal.style.display = 'none';
    cancelBtn.onclick = () => modal.style.display = 'none';
    
    // Close modal when clicking outside of it
    window.onclick = (event) => {
      if (event.target === modal) {
        modal.style.display = 'none';
      }
    };
    
    // Handle form submission
    editForm.onsubmit = function(e) {
      e.preventDefault();
      
      const rowIndex = parseInt(document.getElementById('edit-row-index').value);
      const date = document.getElementById('edit-date').value;
      const project = document.getElementById('edit-project').value;
      const startTime = document.getElementById('edit-start').value;
      const endTime = document.getElementById('edit-end').value;
      const notes = document.getElementById('edit-notes').value;
      
      // Calculate duration in minutes
      const startDateTime = new Date(`${date}T${startTime}`);
      const endDateTime = new Date(`${date}T${endTime}`);
      const durationMinutes = Math.round((endDateTime - startDateTime) / 60000);
      
      // Update session in our array
      sessions[rowIndex] = {
        date,
        startTime,
        endTime,
        duration: durationMinutes,
        project,
        notes
      };
      
      // Rebuild CSV content
      const newCsvContent = rebuildCsvContent();
      
      // Save to file
      const result = window.api.saveCSV(newCsvContent);
      if (result.error) {
        alert(`Error saving changes: ${result.error}`);
      } else {
        // Refresh the table
        displaySessions();
        // Close the modal
        modal.style.display = 'none';
      }
    };
    
    // Rebuild CSV content from sessions array
    function rebuildCsvContent() {
      let content = 'date,start_time,end_time,duration_minutes,project,notes\n';
      
      sessions.forEach(session => {
        content += `${session.date},${session.startTime},${session.endTime},${session.duration},"${session.project}","${session.notes}"\n`;
      });
      
      return content;
    }
    
    // Open edit modal for a session
    function editSession(index) {
      const session = sessions[index];
      
      document.getElementById('edit-row-index').value = index;
      document.getElementById('edit-date').value = session.date;
      document.getElementById('edit-project').value = session.project;
      document.getElementById('edit-start').value = session.startTime;
      document.getElementById('edit-end').value = session.endTime;
      document.getElementById('edit-notes').value = session.notes || '';
      
      modal.style.display = 'block';
    }
    
    // Display sessions in the table
    function displaySessions() {
      // Sort by date and time (newest first)
      sessions.sort((a, b) => {
        const dateA = new Date(`${a.date}T${a.startTime}`);
        const dateB = new Date(`${b.date}T${b.startTime}`);
        return dateB - dateA;
      });
      
      // Generate table rows
      let tableHtml = '';
      sessions.forEach((session, index) => {
        tableHtml += `
          <tr>
            <td>${session.date}</td>
            <td>${session.project}</td>
            <td>${session.startTime}</td>
            <td>${session.endTime}</td>
            <td>${session.duration} min</td>
            <td>${session.notes || ''}</td>
            <td>
              <button onclick="editSession(${index})">Edit</button>
            </td>
          </tr>
        `;
      });
      
      document.getElementById('sessions-body').innerHTML = tableHtml || 
        '<tr><td colspan="7">No sessions recorded yet</td></tr>';
      
      // Calculate today's stats
      updateTodayStats();
    }
    
    // Update today's stats
    function updateTodayStats() {
      const today = new Date().toISOString().split('T')[0];
      const todaySessions = sessions.filter(s => s.date === today);
      
      if (todaySessions.length > 0) {
        const totalMinutes = todaySessions.reduce((sum, s) => sum + s.duration, 0);
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        
        document.getElementById('today-stats').innerHTML = `
          <p>Total time: ${hours}h ${minutes}m</p>
          <p>Sessions: ${todaySessions.length}</p>
        `;
      } else {
        document.getElementById('today-stats').innerHTML = 
          '<p>No sessions recorded today</p>';
      }
    }
    
    // Parse CSV data
    function parseCSV(csvText) {
      const rows = csvText.split('\n');
      const result = [];
      
      // Skip header row and empty last row if exists
      for (let i = 1; i < rows.length; i++) {
        if (rows[i].trim() === '') continue;
        
        // Split by comma but respect quotes
        const parseLine = (line) => {
          const result = [];
          let inQuotes = false;
          let current = '';
          
          for (let char of line) {
            if (char === '"') {
              inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
              result.push(current);
              current = '';
            } else {
              current += char;
            }
          }
          
          result.push(current); // Add the last field
          return result;
        };
        
        const cols = parseLine(rows[i]);
        
        if (cols.length >= 5) {
          result.push({
            date: cols[0],
            startTime: cols[1],
            endTime: cols[2],
            duration: parseInt(cols[3]),
            project: cols[4].replace(/"/g, ''),
            notes: cols.length >= 6 ? cols[5].replace(/"/g, '') : ''
          });
        }
      }
      
      return result;
    }
    
    // Load CSV data
    function loadSessionData() {
      try {
        const result = window.api.loadCSV();
        
        if (result.error) {
          document.getElementById('sessions-body').innerHTML = 
            '<tr><td colspan="7">No sessions recorded yet</td></tr>';
          return;
        }
        
        csvData = result.data;
        sessions = parseCSV(csvData);
        
        displaySessions();
      } catch (error) {
        console.error('Error loading session data:', error);
        document.getElementById('sessions-body').innerHTML = 
          '<tr><td colspan="7">Error loading sessions</td></tr>';
      }
    }
    
    // Load data when page loads
    document.addEventListener('DOMContentLoaded', loadSessionData);
  </script>
</body>
</html>